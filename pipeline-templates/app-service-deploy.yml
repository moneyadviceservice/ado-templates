jobs:
  - job: Deploy
    displayName: 'Deploy to $(appServiceName)'
    pool:
      vmImage: $(vmImageName)
    steps:
      - task: DownloadPipelineArtifact@2
        displayName: 'Download Build Artifact'
        inputs:
          buildType: 'current'
          artifactName: 'drop'
          targetPath: '$(Pipeline.Workspace)/drop'

      - task: AzureCLI@2
        displayName: Whitelist Agent IP
        inputs:
          azureSubscription: '$(subscription)'
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            AGENT_IP=$(curl -s https://api.ipify.org)

            echo "$AGENT_IP"

            TIMESTAMP=$(date +%H%M%S)
            PRIORITY=30$(date +%S)
            az network nsg rule create --resource-group maps-hub-${{ parameters.env }} --nsg-name mhpd-app-nsg-${{ parameters.env }} --name allow-agent-ip-$TIMESTAMP --priority $PRIORITY --access Allow --direction Inbound --protocol "*" --source-address-prefixes $AGENT_IP --source-port-ranges "*" --destination-address-prefixes "*" --destination-port-ranges "*"

      - task: AzureCLI@2
        displayName: Add Agent IP to App Service
        inputs:
          azureSubscription: '$(subscription)'
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            AGENT_IP=$(curl -s https://api.ipify.org)

            echo "$AGENT_IP"

            TIMESTAMP=$(date +%H%M%S)
            PRIORITY=30$(date +%S)
            az webapp config access-restriction add --resource-group $(resourceGroupName) --name CDA-service-${{ parameters.env }} --rule-name allow-agent-ip-$TIMESTAMP --action Allow --ip-address $AGENT_IP --priority 100 --description "Allow pipeline agent IP $AGENT_IP" --scm-site true

      - task: AzureWebApp@1
        displayName: 'Azure App Service Deploy: $(appServiceName)'
        inputs:
          azureSubscription: '$(subscription)'
          appType: 'webAppLinux'
          appName: '$(appServiceName)'
          resourceGroupName: '$(resourceGroupName)'
          package: '$(Pipeline.Workspace)/drop/${{ parameters.packagePath }}.zip'
          runtimeStack: 'DOTNETCORE|8.0'

      - task: AzureWebApp@1
        inputs:
          azureSubscription: '$(subscription)'
          appType: webAppLinux #webApp for Windows
          appName: '$(appServiceName)'
          deployToSlotOrASE: true
          resourceGroupName: '$(resourceGroupName)'
          slotName: '$(slotName)'
          package: '$(Pipeline.Workspace)/drop/${{ parameters.packagePath }}.zip'

      - task: AzureAppServiceManage@0
        inputs:
          azureSubscription: '$(subscription)'
          appType: webAppLinux
          WebAppName: '$(appServiceName)'
          ResourceGroupName: '$(resourceGroupName)'
          SourceSlot: '$(slotName)'
          SwapWithProduction: true